{% extends 'layout.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Главная</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('articles') }}">Статьи</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('view_article', article_id=article.id) }}">{{ article.title }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">Редактирование</li>
            </ol>
        </nav>
        
        <h1>Редактирование статьи</h1>
        <p class="mb-4">Измените информацию статьи и нажмите кнопку "Сохранить изменения".</p>
        
        <form method="post" enctype="multipart/form-data" id="articleForm">
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Название статьи</label>
                        <input type="text" class="form-control" id="title" name="title" value="{{ article.title }}" required>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="content" class="form-label fw-bold">Содержание статьи</label>
                        <div class="alert alert-info small">
                            <strong><i class="bi bi-info-circle me-2"></i>Подсказка:</strong>
                            <p class="mb-1">Для создания содержания статьи, используйте заголовки в одном из форматов:</p>
                            <ul class="mb-0">
                                <li>В стиле Markdown: <code># Заголовок 1</code>, <code>## Заголовок 2</code> и т.д.</li>
                                <li>Выделение жирным: <code>*Заголовок раздела*</code> (весь текст строки)</li>
                            </ul>
                            <p class="mt-2 mb-0">Заголовки будут автоматически добавлены в содержание статьи.</p>
                        </div>
                        <textarea class="form-control" id="content" name="content" rows="15" required>{{ article.content }}</textarea>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Материалы статьи</h5>
                    <button type="button" class="btn btn-primary btn-sm" id="addFileBtn">
                        <i class="bi bi-plus-circle me-1"></i> Добавить файл
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3" id="filesContainer">
                        <p class="text-muted mb-3">Вы можете прикрепить изображения, видео или документы к вашей статье.</p>
                        
                        <div class="row">
                            {% if article.files %}
                                {% for file in article.files %}
                                    <div class="col-md-3 mb-3 file-item" data-file-id="{{ file.id }}">
                                        <div class="card h-100 shadow-sm">
                                            {% if file.file_type == 'image' %}
                                                <div class="position-relative">
                                                    <img src="{{ file.file_data }}" class="card-img-top" alt="{{ file.filename }}" style="max-height: 150px; object-fit: cover;">
                                                    <div class="position-absolute top-0 end-0 p-2">
                                                        <span class="badge bg-primary">Изображение</span>
                                                    </div>
                                                </div>
                                            {% elif file.file_type == 'video' %}
                                                <div class="position-relative">
                                                    <div class="d-flex justify-content-center align-items-center bg-light" style="height: 150px;">
                                                        <i class="bi bi-camera-video text-primary" style="font-size: 3rem;"></i>
                                                    </div>
                                                    <div class="position-absolute top-0 end-0 p-2">
                                                        <span class="badge bg-success">Видео</span>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="position-relative">
                                                    <div class="d-flex justify-content-center align-items-center bg-light" style="height: 150px;">
                                                        <i class="bi bi-file-earmark-text text-primary" style="font-size: 3rem;"></i>
                                                    </div>
                                                    <div class="position-absolute top-0 end-0 p-2">
                                                        <span class="badge bg-secondary">Документ</span>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            <div class="card-body d-flex flex-column">
                                                <p class="card-text small text-truncate mb-2">{{ file.filename }}</p>
                                                <div class="mt-auto">
                                                    <div class="btn-group w-100">
                                                        <a href="{{ file.file_data }}" download="{{ file.filename }}" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-download"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" data-file-id="{{ file.id }}">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <!-- Скрытый input для старой версии загрузки (для совместимости) -->
                        <input type="file" class="d-none" id="files" name="files" multiple>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('view_article', article_id=article.id) }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i> Отмена
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i> Сохранить изменения
                </button>
            </div>
        </form>
        
        <!-- Модальное окно для добавления файла -->
        <div class="modal fade" id="addFileModal" tabindex="-1" aria-labelledby="addFileModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addFileModalLabel">Добавить файл</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="fileUpload" class="form-label">Выберите файл для загрузки</label>
                            <input class="form-control" type="file" id="fileUpload">
                            <div class="form-text">Поддерживаются изображения, видео и документы.</div>
                        </div>
                        <div id="filePreview" class="text-center my-3 d-none">
                            <h6>Предпросмотр:</h6>
                            <div id="previewContent"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" id="uploadFileBtn" disabled>Загрузить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Инициализация модального окна
    const addFileModal = new bootstrap.Modal(document.getElementById('addFileModal'));
    let tempFiles = []; // Временное хранилище для загруженных файлов
    const articleId = {{ article.id }}; // ID текущей статьи
    
    // Обработчики удаления существующих файлов
    document.querySelectorAll('.delete-file-btn').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Вы уверены, что хотите удалить этот файл?')) {
                const fileId = this.dataset.fileId;
                deleteFile(fileId);
            }
        });
    });
    
    // Функция для удаления файла через AJAX
    function deleteFile(fileId) {
        fetch(`/delete_article_file/${fileId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Удаляем элемент из DOM
                document.querySelector(`.file-item[data-file-id="${fileId}"]`).remove();
                showNotification('Файл успешно удален', 'success');
            } else {
                showNotification('Ошибка при удалении файла: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showNotification('Произошла ошибка при удалении файла', 'danger');
        });
    }
    
    // Показать уведомление
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed bottom-0 end-0 m-3`;
        notification.innerHTML = `
            <i class="bi bi-info-circle me-2"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
        `;
        document.body.appendChild(notification);
        
        // Удалить уведомление через 3 секунды
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Открыть модальное окно при нажатии на кнопку "Добавить файл"
    document.getElementById('addFileBtn').addEventListener('click', function() {
        document.getElementById('fileUpload').value = '';
        document.getElementById('filePreview').classList.add('d-none');
        document.getElementById('previewContent').innerHTML = '';
        document.getElementById('uploadFileBtn').disabled = true;
        addFileModal.show();
    });
    
    // Предпросмотр выбранного файла
    document.getElementById('fileUpload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) {
            document.getElementById('filePreview').classList.add('d-none');
            document.getElementById('uploadFileBtn').disabled = true;
            return;
        }
        
        document.getElementById('uploadFileBtn').disabled = false;
        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = '';
        
        if (file.type.startsWith('image/')) {
            // Предпросмотр изображения
            const img = document.createElement('img');
            img.className = 'img-fluid';
            img.style.maxHeight = '200px';
            img.src = URL.createObjectURL(file);
            previewContent.appendChild(img);
        } else if (file.type.startsWith('video/')) {
            // Иконка видео
            const videoIcon = document.createElement('div');
            videoIcon.innerHTML = `
                <i class="bi bi-camera-video text-primary" style="font-size: 4rem;"></i>
                <p class="mt-2">${file.name}</p>
            `;
            previewContent.appendChild(videoIcon);
        } else {
            // Иконка документа
            const docIcon = document.createElement('div');
            docIcon.innerHTML = `
                <i class="bi bi-file-earmark-text text-primary" style="font-size: 4rem;"></i>
                <p class="mt-2">${file.name}</p>
            `;
            previewContent.appendChild(docIcon);
        }
        
        document.getElementById('filePreview').classList.remove('d-none');
    });
    
    // Обработка нажатия на кнопку загрузки файла
    document.getElementById('uploadFileBtn').addEventListener('click', function() {
        const fileInput = document.getElementById('fileUpload');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        // Создаем FormData для отправки файла
        const formData = new FormData();
        formData.append('file', file);
        
        // Загружаем файл на сервер через AJAX
        fetch(`/add_article_file/${articleId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Добавляем новый файл в DOM
                const filesContainer = document.querySelector('#filesContainer .row');
                filesContainer.insertAdjacentHTML('beforeend', data.preview_html);
                
                // Добавляем обработчик для новой кнопки удаления
                const newDeleteBtn = document.querySelector(`.file-item[data-file-id="${data.file_id}"] .delete-file-btn`);
                if (newDeleteBtn) {
                    newDeleteBtn.addEventListener('click', function() {
                        if (confirm('Вы уверены, что хотите удалить этот файл?')) {
                            const fileId = this.dataset.fileId;
                            deleteFile(fileId);
                        }
                    });
                }
                
                // Закрываем модальное окно
                addFileModal.hide();
                showNotification('Файл успешно добавлен', 'success');
            } else {
                showNotification('Ошибка при загрузке файла: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showNotification('Произошла ошибка при загрузке файла', 'danger');
        });
    });
</script>
{% endblock %} 